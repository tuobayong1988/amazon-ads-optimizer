# 广告位置智能倾斜算法详细设计

## 一、概述

广告位置智能倾斜功能的核心是通过算法自动分析三个广告位置（Top of Search、Product Page、Rest of Search）的表现数据，计算每个位置的效率评分，并据此自动调整出价倾斜比例，以实现广告投放效果的最大化。

本文档详细描述评分算法、倾斜比例计算逻辑、调整决策流程和安全边界机制。

---

## 二、位置效率评分算法

### 2.1 评分指标体系

位置效率评分综合考虑以下核心指标：

| 指标 | 符号 | 计算公式 | 说明 |
|------|------|----------|------|
| 广告投资回报率 | ROAS | 销售额 / 花费 | 每花费1元带来的销售额 |
| 广告成本销售比 | ACoS | 花费 / 销售额 × 100% | 广告花费占销售额的比例 |
| 转化率 | CVR | 订单数 / 点击数 × 100% | 点击转化为订单的比例 |
| 点击率 | CTR | 点击数 / 展示数 × 100% | 展示转化为点击的比例 |
| 平均点击成本 | CPC | 花费 / 点击数 | 每次点击的平均成本 |

### 2.2 评分公式

**综合效率评分公式**：

```
EfficiencyScore = W_roas × ROAS_norm + W_cvr × CVR_norm + W_ctr × CTR_norm - W_cpc × CPC_norm
```

其中：
- `W_roas`、`W_cvr`、`W_ctr`、`W_cpc` 为各指标权重
- `*_norm` 表示归一化后的指标值

### 2.3 指标归一化

为使不同量纲的指标可以比较，采用Min-Max归一化：

```
X_norm = (X - X_min) / (X_max - X_min)
```

其中 `X_min` 和 `X_max` 取自同一广告活动下三个位置的最小值和最大值。

**特殊处理**：
- 当三个位置的某指标值相同时，归一化值统一设为0.5
- CPC为负向指标，归一化后取反（1 - CPC_norm）

### 2.4 权重分配策略

权重根据用户设定的优化目标动态调整：

| 优化目标 | W_roas | W_cvr | W_ctr | W_cpc |
|----------|--------|-------|-------|-------|
| ROAS优先 | 0.50 | 0.25 | 0.10 | 0.15 |
| ACoS优先 | 0.45 | 0.25 | 0.10 | 0.20 |
| 销售额优先 | 0.35 | 0.30 | 0.20 | 0.15 |
| 利润优先 | 0.40 | 0.30 | 0.10 | 0.20 |

### 2.5 数据置信度评估

为确保评分的可靠性，系统会评估数据的置信度：

```
Confidence = min(1, Clicks / MinClicks) × min(1, Spend / MinSpend)
```

| 置信度等级 | 点击数要求 | 花费要求 | 评分权重 |
|------------|------------|----------|----------|
| 高置信度 | ≥100 | ≥$50 | 100% |
| 中置信度 | 50-99 | $20-$49 | 75% |
| 低置信度 | 20-49 | $10-$19 | 50% |
| 不可信 | <20 | <$10 | 不参与计算 |

**低置信度处理**：当某位置数据置信度不足时，该位置的倾斜比例保持不变或使用保守策略。

---

## 三、最优倾斜比例计算

### 3.1 基础倾斜比例公式

基于效率评分差异计算建议倾斜比例：

```
SuggestedBias = BaselineBias + (Score - AvgScore) × ScaleFactor × 100%
```

其中：
- `BaselineBias`：当前倾斜比例（默认0%）
- `Score`：该位置的效率评分
- `AvgScore`：三个位置的平均效率评分
- `ScaleFactor`：缩放因子（默认2.0，可配置）

### 3.2 倾斜比例计算示例

假设三个位置的效率评分如下：

| 位置 | 效率评分 | 与平均分差值 | 建议倾斜 |
|------|----------|--------------|----------|
| Top of Search | 0.85 | +0.18 | +36% |
| Product Page | 0.70 | +0.03 | +6% |
| Rest of Search | 0.45 | -0.22 | 基准(0%) |

平均分 = (0.85 + 0.70 + 0.45) / 3 = 0.67

计算过程：
- Top of Search: 0 + (0.85 - 0.67) × 2.0 × 100% = +36%
- Product Page: 0 + (0.70 - 0.67) × 2.0 × 100% = +6%
- Rest of Search: 作为基准，不可调整

### 3.3 倾斜上下限约束

系统设置倾斜比例的硬性边界：

| 约束类型 | 最小值 | 最大值 | 说明 |
|----------|--------|--------|------|
| 绝对边界 | 0% | 200% | Amazon API限制 |
| 建议边界 | 0% | 150% | 系统推荐范围 |
| 单次调整 | -20% | +20% | 单次最大调整幅度 |

### 3.4 渐进式调整策略

为避免大幅波动影响广告表现，采用渐进式调整：

```
ActualAdjustment = min(MaxStepSize, |SuggestedBias - CurrentBias|) × sign(SuggestedBias - CurrentBias)
NewBias = CurrentBias + ActualAdjustment
```

**调整步长配置**：

| 评分差异 | 单次最大步长 | 说明 |
|----------|--------------|------|
| 差异 < 0.1 | 5% | 微调 |
| 0.1 ≤ 差异 < 0.2 | 10% | 小幅调整 |
| 0.2 ≤ 差异 < 0.3 | 15% | 中幅调整 |
| 差异 ≥ 0.3 | 20% | 大幅调整 |

---

## 四、调整决策流程

### 4.1 决策流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           位置倾斜调整决策流程                                │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────┐
    │ 开始定时任务   │ ← 每周执行2次（周二、周五）
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │ 获取位置表现   │ ← 过去7天数据
    │ 数据           │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐     否      ┌───────────────┐
    │ 数据量是否     │───────────→│ 跳过本次调整   │
    │ 达到阈值?      │            │ 记录原因       │
    └───────┬───────┘            └───────────────┘
            │ 是
            ▼
    ┌───────────────┐
    │ 计算各位置     │
    │ 效率评分       │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │ 计算建议       │
    │ 倾斜比例       │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐     否      ┌───────────────┐
    │ 与当前比例     │───────────→│ 保持当前设置   │
    │ 差异>5%?       │            │ 无需调整       │
    └───────┬───────┘            └───────────────┘
            │ 是
            ▼
    ┌───────────────┐     否      ┌───────────────┐
    │ 是否在冷却期   │───────────→│ 加入待执行     │
    │ 内?            │            │ 队列           │
    └───────┬───────┘            └───────────────┘
            │ 否
            ▼
    ┌───────────────┐
    │ 应用渐进式     │
    │ 调整策略       │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐     失败    ┌───────────────┐
    │ 调用Amazon     │───────────→│ 记录错误       │
    │ API执行调整    │            │ 发送告警       │
    └───────┬───────┘            └───────────────┘
            │ 成功
            ▼
    ┌───────────────┐
    │ 记录调整历史   │
    │ 设置复盘时间   │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │ 结束           │
    └───────────────┘
```

### 4.2 调整触发条件

系统在满足以下所有条件时才会触发调整：

| 条件类型 | 具体要求 | 说明 |
|----------|----------|------|
| 数据量要求 | 总点击数 ≥ 100 | 确保数据有统计意义 |
| 花费要求 | 总花费 ≥ $30 | 确保有足够的投入产出数据 |
| 差异阈值 | 建议倾斜与当前差异 > 5% | 避免频繁微调 |
| 冷却期 | 距上次调整 ≥ 3.5天 | 确保每周最多2次 |
| 自动优化开关 | 用户已启用自动优化 | 尊重用户选择 |

### 4.3 调整幅度控制

**单次调整限制**：

```
MaxSingleAdjustment = min(20%, |SuggestedBias - CurrentBias|)
```

**累计调整限制**：

```
MaxWeeklyAdjustment = 40%  // 每周累计调整不超过40%
```

如果本周已调整过，第二次调整的幅度 = min(单次限制, 40% - 本周已调整幅度)

---

## 五、安全边界和异常保护

### 5.1 安全边界机制

| 保护类型 | 触发条件 | 处理方式 |
|----------|----------|----------|
| 倾斜上限保护 | 建议倾斜 > 200% | 限制为200% |
| 倾斜下限保护 | 建议倾斜 < 0% | 限制为0% |
| 单次调整保护 | 单次调整 > 20% | 限制为20% |
| 数据不足保护 | 点击数 < 20 | 跳过该位置 |
| 异常数据保护 | 指标异常波动 > 50% | 人工审核 |

### 5.2 异常检测规则

系统会检测以下异常情况：

```typescript
interface AnomalyDetection {
  // 指标异常波动检测
  metricVolatility: {
    threshold: 0.5,  // 50%波动阈值
    metrics: ['roas', 'acos', 'cvr', 'ctr'],
    action: 'flag_for_review'
  };
  
  // 位置数据缺失检测
  missingData: {
    maxMissingDays: 2,  // 最多允许2天数据缺失
    action: 'use_available_data'
  };
  
  // 极端值检测
  extremeValues: {
    roasMax: 20,      // ROAS超过20视为异常
    acosMin: 0.01,    // ACoS低于1%视为异常
    action: 'cap_to_normal_range'
  };
}
```

### 5.3 回滚机制

当调整后效果明显恶化时，系统支持自动回滚：

| 回滚触发条件 | 观察期 | 回滚动作 |
|--------------|--------|----------|
| ACoS上升 > 20% | 3天 | 回滚到上次设置 |
| ROAS下降 > 25% | 3天 | 回滚到上次设置 |
| 花费异常飙升 > 50% | 1天 | 立即回滚并告警 |

---

## 六、算法参数配置

### 6.1 默认参数

```typescript
const defaultConfig = {
  // 评分权重（ROAS优先模式）
  weights: {
    roas: 0.50,
    cvr: 0.25,
    ctr: 0.10,
    cpc: 0.15
  },
  
  // 数据要求
  dataRequirements: {
    minClicks: 50,
    minSpend: 20,
    minDays: 7
  },
  
  // 调整限制
  adjustmentLimits: {
    minBias: 0,
    maxBias: 200,
    maxSingleStep: 20,
    maxWeeklyTotal: 40,
    minDifferenceToAdjust: 5
  },
  
  // 冷却期（小时）
  cooldownPeriod: 84,  // 3.5天
  
  // 缩放因子
  scaleFactor: 2.0
};
```

### 6.2 用户可配置参数

| 参数 | 默认值 | 可配置范围 | 说明 |
|------|--------|------------|------|
| 优化目标 | ROAS优先 | ROAS/ACoS/销售额/利润 | 影响权重分配 |
| 最大倾斜比例 | 150% | 50%-200% | 用户风险偏好 |
| 单次最大调整 | 20% | 5%-30% | 调整激进程度 |
| 最小数据要求 | 50点击 | 20-200 | 数据可靠性要求 |
| 调整频率 | 每周2次 | 每周1-2次 | 调整频繁程度 |

---

## 七、评分计算示例

### 7.1 示例数据

某广告活动过去7天的位置表现数据：

| 位置 | 展示 | 点击 | 花费 | 销售额 | 订单 |
|------|------|------|------|--------|------|
| Top of Search | 10,000 | 300 | $150 | $600 | 15 |
| Product Page | 8,000 | 200 | $100 | $350 | 9 |
| Rest of Search | 15,000 | 250 | $80 | $200 | 5 |

### 7.2 指标计算

| 位置 | ROAS | ACoS | CVR | CTR | CPC |
|------|------|------|-----|-----|-----|
| Top of Search | 4.00 | 25.0% | 5.0% | 3.0% | $0.50 |
| Product Page | 3.50 | 28.6% | 4.5% | 2.5% | $0.50 |
| Rest of Search | 2.50 | 40.0% | 2.0% | 1.7% | $0.32 |

### 7.3 归一化处理

| 位置 | ROAS_norm | CVR_norm | CTR_norm | CPC_norm(反) |
|------|-----------|----------|----------|--------------|
| Top of Search | 1.00 | 1.00 | 1.00 | 0.00 |
| Product Page | 0.67 | 0.83 | 0.62 | 0.00 |
| Rest of Search | 0.00 | 0.00 | 0.00 | 1.00 |

### 7.4 效率评分计算

使用ROAS优先权重（0.50, 0.25, 0.10, 0.15）：

| 位置 | 评分计算 | 最终评分 |
|------|----------|----------|
| Top of Search | 0.50×1.00 + 0.25×1.00 + 0.10×1.00 + 0.15×0.00 | **0.85** |
| Product Page | 0.50×0.67 + 0.25×0.83 + 0.10×0.62 + 0.15×0.00 | **0.60** |
| Rest of Search | 0.50×0.00 + 0.25×0.00 + 0.10×0.00 + 0.15×1.00 | **0.15** |

平均评分 = (0.85 + 0.60 + 0.15) / 3 = 0.53

### 7.5 建议倾斜比例

| 位置 | 评分差值 | 建议倾斜 | 当前倾斜 | 实际调整 |
|------|----------|----------|----------|----------|
| Top of Search | +0.32 | +64% | +20% | +40%（限制为+20%步长） |
| Product Page | +0.07 | +14% | 0% | +14% |
| Rest of Search | -0.38 | 基准 | 基准 | 基准 |

---

## 八、界面交互设计

### 8.1 位置表现概览卡片

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 📍 广告位置智能倾斜                                    [自动优化: ● 已启用] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  位置表现对比（过去7天）                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 位置             │ 效率评分 │ 当前倾斜 │ 建议倾斜 │ 状态           │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ 🔝 搜索顶部      │ ████████ 0.85 │ +20%  │ +40%  │ ⬆️ 建议提高   │   │
│  │ 📦 商品详情页    │ ██████ 0.60   │ 0%    │ +14%  │ ⬆️ 建议提高   │   │
│  │ 📋 其他搜索位置  │ ██ 0.15       │ 基准   │ 基准   │ ✓ 无需调整   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  效率评分构成                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │         ROAS(50%)  CVR(25%)   CTR(10%)   CPC(15%)                   │   │
│  │ 搜索顶部  ████████   ████████   ████████   ░░░░░░░░                 │   │
│  │ 商品页    █████░░░   ██████░░   █████░░░   ░░░░░░░░                 │   │
│  │ 其他位置  ░░░░░░░░   ░░░░░░░░   ░░░░░░░░   ████████                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  💡 AI建议: 搜索顶部效率最高(0.85)，建议将倾斜从+20%提高到+40%              │
│                                                                             │
│  [立即执行建议] [查看详细分析] [调整参数] [查看历史]                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 参数配置面板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ⚙️ 位置倾斜算法参数配置                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 优化目标                                                                    │
│ ┌─────────────────────────────────────────────────────────────────────┐   │
│ │ ● ROAS优先   ○ ACoS优先   ○ 销售额优先   ○ 利润优先                  │   │
│ └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 权重分配（当前: ROAS优先）                                                   │
│ ┌─────────────────────────────────────────────────────────────────────┐   │
│ │ ROAS权重:  [========●=] 50%                                         │   │
│ │ CVR权重:   [====●=====] 25%                                         │   │
│ │ CTR权重:   [=●========] 10%                                         │   │
│ │ CPC权重:   [==●=======] 15%                                         │   │
│ └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 调整限制                                                                    │
│ ┌─────────────────────────────────────────────────────────────────────┐   │
│ │ 最大倾斜比例:    [150%]  │ 单次最大调整:  [20%]                      │   │
│ │ 调整触发阈值:    [5%]    │ 调整频率:      [每周2次 ▼]               │   │
│ └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 数据要求                                                                    │
│ ┌─────────────────────────────────────────────────────────────────────┐   │
│ │ 最少点击数:      [50]    │ 最少花费:      [$20]                      │   │
│ │ 数据周期:        [7天 ▼]                                            │   │
│ └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ [恢复默认] [保存配置]                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 调整历史记录

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 📜 位置倾斜调整历史                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────┐   │
│ │ 时间          │ 位置       │ 调整前 │ 调整后 │ 原因        │ 效果   │   │
│ ├─────────────────────────────────────────────────────────────────────┤   │
│ │ 01/06 10:00  │ 搜索顶部   │ +20%  │ +40%  │ 效率评分高  │ 待复盘 │   │
│ │ 01/06 10:00  │ 商品详情页 │ 0%    │ +14%  │ 效率评分高  │ 待复盘 │   │
│ │ 01/03 10:00  │ 搜索顶部   │ +10%  │ +20%  │ 效率评分高  │ ✓ +8% │   │
│ │ 12/31 10:00  │ 商品详情页 │ +5%   │ 0%    │ 效率下降    │ ✓ +3% │   │
│ └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 复盘统计: 调整成功率 75% │ 平均效果提升 +5.2%                                │
│                                                                             │
│ [导出历史] [查看详细复盘]                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、实施建议

### 9.1 开发优先级

| 优先级 | 功能模块 | 预计工时 |
|--------|----------|----------|
| P0 | 位置数据同步与存储 | 2天 |
| P0 | 效率评分计算引擎 | 2天 |
| P1 | 倾斜比例计算与调整API | 2天 |
| P1 | 位置表现概览卡片 | 1天 |
| P2 | 参数配置面板 | 1天 |
| P2 | 调整历史与复盘 | 1天 |

### 9.2 测试要点

1. **评分算法准确性** - 验证归一化和权重计算的正确性
2. **边界条件处理** - 测试数据不足、极端值等边界情况
3. **调整限制有效性** - 验证单次调整和累计调整限制
4. **冷却期机制** - 验证每周最多2次的限制
5. **回滚机制** - 测试效果恶化时的自动回滚

---

**文档版本**: v1.0  
**作者**: Manus AI  
**最后更新**: 2026-01-06
