# Amazon Advertising API 数据同步机制架构文档

**作者**: Manus AI  
**日期**: 2026年1月13日  
**版本**: 1.0

---

## 1. 架构概述

本系统采用**双轨制数据同步架构**，同时支持两种数据获取方式，以确保数据的准确性、实时性和完整性：

| 同步方式 | 数据来源 | 延迟 | 准确性 | 用途 |
|---------|---------|------|--------|------|
| **传统报表API** | Amazon Advertising API | T-1（隔天） | 高（最终结算数据） | 历史分析、校验基准 |
| **Amazon Marketing Stream (AMS)** | AWS SQS实时推送 | 近实时（分钟级） | 中（可能有归因延迟） | 实时监控、预警 |

这种架构的核心思想是：**AMS提供实时性，API提供准确性**，两者互补形成完整的数据同步体系。

---

## 2. 核心组件

### 2.1 Amazon Ads API客户端 (`amazonAdsApi.ts`)

这是与Amazon Advertising API交互的核心模块，实现了完整的OAuth 2.0认证和API调用功能。

**支持的区域端点：**

| 区域 | 端点URL | 覆盖市场 |
|-----|---------|---------|
| NA (北美) | `https://advertising-api.amazon.com` | US, CA, MX, BR |
| EU (欧洲) | `https://advertising-api-eu.amazon.com` | UK, DE, FR, IT, ES, NL, SE, PL, TR, AE, SA, EG, IN |
| FE (远东) | `https://advertising-api-fe.amazon.com` | JP, AU, SG |

**核心功能：**
- OAuth 2.0 Token管理（自动刷新）
- 广告活动列表获取（SP/SB/SD）
- 广告组、关键词、商品定位获取
- 绩效报告请求和下载
- 出价调整API调用

### 2.2 数据同步服务 (`amazonSyncService.ts`)

负责从Amazon API同步数据到本地数据库的核心服务。

**同步内容：**
- 广告活动（SP/SB/SD三种类型）
- 广告组
- 关键词和商品定位
- 绩效数据（含归因回溯）

**归因回溯机制：**

> 亚马逊的销售数据在7-14天内会变动（用户点击后过几天才买），因此每次同步都需要回溯过去14天的数据，覆盖旧记录，确保存下来的数据和亚马逊后台最终结算的数据一致。

| 广告类型 | 归因窗口 | 回溯天数 |
|---------|---------|---------|
| SP (Sponsored Products) | 14天 | 14天 |
| SB (Sponsored Brands) | 30天 | 30天 |
| SD (Sponsored Display) | 30天 | 30天 |

### 2.3 SQS消费者服务 (`sqsConsumerService.ts`)

从Amazon Marketing Stream队列读取实时广告数据的服务。

**支持的队列类型：**

| 队列类型 | 数据内容 | 更新频率 |
|---------|---------|---------|
| sp-traffic | 展示、点击、花费 | 近实时（分钟级） |
| sp-conversion | 销售、订单 | 近实时（有归因延迟） |
| budget-usage | 预算使用情况 | 近实时 |

**消息格式示例（sp-traffic）：**
```json
{
  "advertiser_id": "A2IDI0O8158CRH",
  "marketplace_id": "ATVPDKIKX0DER",
  "dataset_id": "sp-traffic",
  "campaign_id": "123456789",
  "impressions": 1000,
  "clicks": 50,
  "cost": 2500,
  "event_hour": "2026-01-13T08:00:00Z"
}
```

### 2.4 双轨制同步服务 (`dualTrackSyncService.ts`)

协调API和AMS两种数据源的核心服务。

**数据源优先级配置：**

| 场景 | 优先级顺序 | 说明 |
|-----|-----------|------|
| 实时展示 | AMS → API | 优先使用AMS数据（延迟低） |
| 历史分析 | API → AMS | 优先使用API数据（准确性高） |
| 报表导出 | Merged → API → AMS | 使用合并后的数据 |

**数据一致性阈值：**
- 数值差异容忍度：5%
- 时间延迟容忍度：60分钟
- 连续不一致告警阈值：3次
- AMS无数据回补阈值：4小时

**数据冻结区策略：**

为了区分"用于决策的数据"和"用于展示的数据"，系统实现了数据冻结区机制：

| 算法类型 | 排除天数 | 说明 |
|---------|---------|------|
| 分时策略 | 3天 | 排除最近3天数据 |
| 竞价算法 | 1天 | 排除最近1天数据 |
| 位置优化 | 3天 | 排除最近3天数据 |

**实时数据可信字段：**
- 可信（无归因延迟）：`spend`, `clicks`, `impressions`
- 不可信（有归因延迟）：`sales`, `orders`, `roas`, `acos`, `cvr`

---

## 3. 定时调度机制

### 3.1 数据同步调度器 (`dataSyncScheduler.ts`)

实现分层同步策略，根据Amazon API速率限制优化同步频率。

**同步层级配置：**

| 层级 | 间隔 | 同步内容 |
|-----|------|---------|
| 高频 (high) | 15分钟 | 广告活动状态、预算 |
| 中频 (medium) | 30分钟 | 广告组、关键词、定位 |
| 低频 (low) | 1小时 | 完整数据同步 |
| 全量 (full) | 30分钟 | 所有数据（60天历史） |

**API请求速率控制：**
- 请求间隔：200毫秒
- 请求队列管理
- 自动重试机制（最多3次）

### 3.2 异步报告任务调度器 (`reportJobScheduler.ts`)

处理Amazon Reporting API的异步报告请求。

**调度配置：**

| 任务类型 | 间隔 | 批次大小 |
|---------|------|---------|
| 提交任务 | 30秒 | 5个 |
| 检查状态 | 60秒 | 10个 |
| 处理报告 | 30秒 | 3个 |
| 清理过期 | 24小时 | 全部 |

**任务状态流转：**
```
pending → submitted → processing → completed/failed
```

### 3.3 绩效同步调度器 (`performanceSyncScheduler.ts`)

专门处理绩效数据的定时同步。

---

## 4. 新店铺初始化策略

#### 4.1 数据分层
| 数据类型 | 时间范围 | 切片大小 | 优先级 |
|---------|---------|---------|--------|
| 热数据 | 最近90天 | 3天/切片 | 高 |
| 冷数据 | 91-365天 | 14天/切片 | 低 |

### 4.2 初始化流程（方案四：按广告类型拆分 + 缩小时间切片）

**任务拆分策略：**
- 热数据：3天切片 × SP/SB/SD = 每个时间段9个任务
- 冷数据：14天切片 × SP/SB/SD = 每个时间段3个任务
- 单个任务数据量小，处理更稳定，失败重试成本低

**初始化步骤：**
1. **创建初始化任务**：为每种广告类型（SP/SB/SD）分别创建报告任务
2. **热数据优先**：先拉取最近90天的数据（30个切片×3类型=90个任务）
3. **冷数据补充**：后台异步拉取91-365天的历史数据（20个切片×3类型=60个任务）
4. **总计任务数**：约150个报告任务

**优势：**
- 任务数量增加，但单个任务数据量大幅减少
- 处理更稳定，API超时风险降低
- 失败重试时只需重新拉取小部分数据

---

## 5. 数据存储结构

### 5.1 核心数据表

| 表名 | 用途 |
|-----|------|
| `campaigns` | 广告活动 |
| `ad_groups` | 广告组 |
| `keywords` | 关键词 |
| `product_targets` | 商品定位 |
| `daily_performance` | 每日绩效数据 |
| `report_jobs` | 异步报告任务队列 |
| `data_sync_jobs` | 数据同步任务记录 |
| `data_sync_logs` | 同步日志 |

### 5.2 数据来源标识

`daily_performance` 表中的 `dataSource` 字段标识数据来源：
- `api`：来自传统报表API
- `ams`：来自Amazon Marketing Stream
- `reporting_api`：来自异步报告API

---

## 6. 时区处理

系统以亚马逊各站点的当地时间为准进行数据同步和展示。

**工具函数（`utils/timezone.ts`）：**
- `getMarketplaceDateRange()`：获取站点当地日期范围
- `getMarketplaceCurrentDate()`：获取站点当前日期
- `getMarketplaceYesterday()`：获取站点昨天日期
- `getMarketplaceHistoricalDateRange()`：获取历史日期范围

---

## 7. 错误处理与重试

### 7.1 同步失败处理

- 自动重试：最多3次
- 指数退避：每次重试间隔递增
- 失败告警：连续失败时发送通知

### 7.2 API限流处理

- 请求队列管理
- 令牌桶限流算法
- 自动降级策略

---

## 8. 监控与告警

### 8.1 健康状态检查

双轨制同步服务提供健康状态API：
- API同步状态
- AMS同步状态
- 最后一致性检查时间
- 整体健康状态（healthy/degraded/error）

### 8.2 告警触发条件

- AMS无数据超过4小时
- API同步连续失败3次
- 数据一致性检查失败
- 预算消耗异常

---

## 9. 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     Amazon Ads Optimizer                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────┐         ┌─────────────────┐                │
│  │  传统报表API     │         │  Amazon Marketing│                │
│  │  (T-1 数据)      │         │  Stream (实时)   │                │
│  └────────┬────────┘         └────────┬────────┘                │
│           │                           │                          │
│           ▼                           ▼                          │
│  ┌─────────────────┐         ┌─────────────────┐                │
│  │ amazonSyncService│         │ sqsConsumerService│              │
│  │ (定时拉取)       │         │ (实时消费)       │                │
│  └────────┬────────┘         └────────┬────────┘                │
│           │                           │                          │
│           └───────────┬───────────────┘                          │
│                       ▼                                          │
│           ┌─────────────────────┐                                │
│           │ dualTrackSyncService │                               │
│           │ (双轨制协调)         │                                │
│           └──────────┬──────────┘                                │
│                      ▼                                           │
│           ┌─────────────────────┐                                │
│           │    MySQL Database    │                               │
│           │  (daily_performance) │                               │
│           └─────────────────────┘                                │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 总结

本系统的Amazon API同步机制具有以下特点：

1. **双轨制架构**：同时支持传统API和实时流，兼顾准确性和实时性
2. **分层同步策略**：根据数据重要性和更新频率采用不同同步间隔
3. **归因回溯机制**：自动回溯14-30天数据，确保最终数据准确
4. **异步报告处理**：避免同步流程长时间等待
5. **数据冻结区**：区分展示数据和决策数据，避免归因延迟影响算法
6. **完善的错误处理**：自动重试、限流、告警机制
7. **时区感知**：以各站点当地时间为准进行数据处理

---

*文档结束*
